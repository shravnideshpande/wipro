package com.capstonepro.tenantservice.service;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.springframework.boot.test.context.SpringBootTest;

import com.capstonepro.tenantservice.entity.Tenant;
import com.capstonepro.tenantservice.entity.TenantAddress;
import com.capstonepro.tenantservice.repository.TenantRepository;


@SpringBootTest(properties = "eureka.client.enabled=false")
public class TenantServiceTest {

	@InjectMocks
	private TenantServiceImpl tenantService;

	@Mock
	private TenantRepository tenantRepository;
	
	@Test
	public void testAddTenant() {
		Tenant tenants = new Tenant();
		TenantAddress tPermanantAdd = new TenantAddress();
		tenants.setTntId(1);
		tenants.setTntFirstName("Henry");
		tenants.setTntLastName("Carl");
		tenants.setAge(28);
		tenants.setContactNum("6754354201");
		tenants.setIdPrrofType("Pan");
		tenants.setIdPrrofNo("IBOPDA643M");
		
		tPermanantAdd.setAddressId(1);
		tPermanantAdd.setHouseNum(10);
		tPermanantAdd.setLane("SMD");
		tPermanantAdd.setCityName("Covey");
		tPermanantAdd.setStateName("London");
		tPermanantAdd.setCountryName("Uk");
		tPermanantAdd.setDiscPin(180925);
		
		
		when(tenantRepository.save(tenants)).thenReturn(tenants);

		Tenant saveTenants = tenantService.saveTenant(tenants);
		
		verify(tenantRepository, times(1)).save(tenants);
		 assertEquals(tenants, saveTenants);
		 assertEquals("Henry", saveTenants.getTntFirstName());
		 assertEquals("Carl", saveTenants.getTntLastName());
		 assertEquals(29, saveTenants.getAge());
	}

	@Test
	public void testGetTenantById() {
		
		Tenant tenants = new Tenant();
		TenantAddress tPermanantAdd = new TenantAddress();
		tenants.setTntId(1);
		tenants.setTntFirstName("Henry");
		tenants.setTntLastName("Carl");
		tenants.setAge(28);
		tenants.setContactNum("6754354201");
		tenants.setIdPrrofType("Pan");
		tenants.setIdPrrofNo("IBOPDA643M");
		
		tPermanantAdd.setAddressId(1);
		tPermanantAdd.setHouseNum(10);
		tPermanantAdd.setLane("SMD");
		tPermanantAdd.setCityName("Covey");
		tPermanantAdd.setStateName("London");
		tPermanantAdd.setCountryName("Uk");
		tPermanantAdd.setDiscPin(180925);
		
		when(tenantRepository.findById(1)).thenReturn(Optional.of(tenants));
		Tenant tenants1 =tenantService.getTenantById(1);
		assertEquals("Henry",tenants.getTntFirstName());
		assertEquals("Carl",tenants.getTntLastName());
	}
	
	@Test
	public void testViewAllTenants() {
		
		Tenant tenant = new Tenant();
		TenantAddress tPermanantAdd = new TenantAddress();
		tenant.setTntId(1);
		tenant.setTntFirstName("Henry");
		tenant.setTntLastName("Carl");
		tenant.setAge(28);
		tenant.setContactNum("6754354201");
		tenant.setIdPrrofType("Pan");
		tenant.setIdPrrofNo("IBOPDA643M");
		
		tPermanantAdd.setAddressId(1);
		tPermanantAdd.setHouseNum(10);
		tPermanantAdd.setLane("SMD");
		tPermanantAdd.setCityName("Covey");
		tPermanantAdd.setStateName("London");
		tPermanantAdd.setCountryName("Uk");
		tPermanantAdd.setDiscPin(180925);

		Tenant tenant1 = new Tenant();
		TenantAddress tPermanantAdd1 = new TenantAddress();
		tenant1.setTntId(1);
		tenant1.setTntFirstName("Henry");
		tenant1.setTntLastName("Carl");
		tenant1.setAge(28);
		tenant1.setContactNum("6754354201");
		tenant1.setIdPrrofType("Pan");
		tenant1.setIdPrrofNo("IBOPDA643M");
		
		tPermanantAdd1.setAddressId(1);
		tPermanantAdd1.setHouseNum(10);
		tPermanantAdd1.setLane("SMD");
		tPermanantAdd1.setCityName("Covey");
		tPermanantAdd1.setStateName("London");
		tPermanantAdd1.setCountryName("Uk");
		tPermanantAdd1.setDiscPin(180925);
		
		Tenant tenant2 = new Tenant();
		TenantAddress tPermanantAdd2 = new TenantAddress();
		tenant2.setTntId(1);
		tenant2.setTntFirstName("Henry");
		tenant2.setTntLastName("Carl");
		tenant2.setAge(28);
		tenant2.setContactNum("6754354201");
		tenant2.setIdPrrofType("Pan");
		tenant2.setIdPrrofNo("IBOPDA643M");
		
		tPermanantAdd2.setAddressId(1);
		tPermanantAdd2.setHouseNum(10);
		tPermanantAdd2.setLane("SMD");
		tPermanantAdd2.setCityName("Covey");
		tPermanantAdd2.setStateName("London");
		tPermanantAdd2.setCountryName("Uk");
		tPermanantAdd2.setDiscPin(180925);
		
		List<Tenant> tenantList = new ArrayList<>();
		tenantList.add(tenant);
		tenantList.add(tenant1);
		tenantList.add(tenant2);
	

		when(tenantRepository.findAll()).thenReturn(tenants);

		List<Tenant> tenantList = tenantService.viewAllTenants();
		assertEquals(2, tenantList.size());

	}		
	
	@Test
	public void testUpdateTenant() {
	   
		Tenant tenant=new Tenant();
		TenantAddress tenantAddress = new TenantAddress();
		tenant.setTenantId(1);
		tenant.setTenantName("Aman");
		tenant.setTenantAge(22);
		tenant.setEmail("aman@xyz.com");
		tenant.setIdType("Aadhar");
		tenant.setIdNo("12345678XXX");
		tenantAddress.setId(1);
		tenantAddress.setHouseNo(20);
		tenantAddress.setCity("Ranchi");
		tenantAddress.setCountry("India");
		tenantAddress.setPin(987654);
		tenantAddress.setState("Jharkhand");
		tenantAddress.setStreet("Hec");

	    when(tenantRepository.findById(1)).thenReturn(Optional.of(tenant));
	    when(tenantRepository.save(tenant)).thenReturn(tenant);

	    tenant.setTenantName("JBN");
		tenant.setTenantAge(23);

	   Tenant updatedTenant = tenantService.updateTenant(tenant);

	    verify(tenantRepository, times(1)).findById(1);
	    verify(tenantRepository, times(1)).save(tenant);
	    assertEquals(tenant, updatedTenant);
	    assertEquals("JBN", updatedTenant.getTenantName());
	    assertEquals(23, updatedTenant.getTenantAge());
	    
	}

	@Test
	public void testDeleteTenant() {		
	
		Tenant tenant=new Tenant();
		TenantAddress tenantAddress = new TenantAddress();
		tenant.setTenantId(1);
		tenant.setTenantName("Aman");
		tenant.setTenantAge(22);
		tenant.setEmail("aman@xyz.com");
		tenant.setIdType("Aadhar");
		tenant.setIdNo("12345678XXX");
		tenantAddress.setId(1);
		tenantAddress.setHouseNo(20);
		tenantAddress.setCity("Ranchi");
		tenantAddress.setCountry("India");
		tenantAddress.setPin(987654);
		tenantAddress.setState("Jharkhand");
		tenantAddress.setStreet("Hec");

		when(tenantRepository.findById(1)).thenReturn(Optional.of(tenant));

		doNothing().when(tenantRepository).delete(tenant);

		tenantService.deleteTenant(1);

		verify(tenantRepository, times(1)).findById(1);
		verify(tenantRepository, times(1)).delete(tenant);

	}

	@Test
	public void testDeleteTenantWihException() {
		Tenant tenant=new Tenant();
		TenantAddress tenantAddress = new TenantAddress();
		tenant.setTenantId(1);
		tenant.setTenantName("Aman");
		tenant.setTenantAge(22);
		tenant.setEmail("aman@xyz.com");
		tenant.setIdType("Aadhar");
		tenant.setIdNo("12345678XXX");
		tenantAddress.setId(1);
		tenantAddress.setHouseNo(20);
		tenantAddress.setCity("Ranchi");
		tenantAddress.setCountry("India");
		tenantAddress.setPin(987654);
		tenantAddress.setState("Jharkhand");
		tenantAddress.setStreet("Hec");

		when(tenantRepository.findById(10))
				.thenThrow(new TenantNotFoundException("Tenant is not existing with id:10"));

		assertThrows(TenantNotFoundException.class, () -> tenantService.deleteTenant(10));

		verify(tenantRepository, times(0)).delete(tenant);
	}

	
}

}
